<!DOCTYPE html>
<html lang="en-US" xmlns:tui>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta http-equiv="content-type" content="text/html;charset=utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
		<title>TUI v2 手册</title>
		
		<link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.css">
		<link rel="stylesheet" href="css/tui2.css" />
		<link rel="stylesheet" href="index.css" />
		
		<script type="text/javascript" src="es5-shim.js"></script>
		<script type="text/javascript" src="jquery-1.11.3.js"></script>
        <script type="text/javascript" src="tui2.js"></script>
		<script type="text/javascript" src="marked.js"></script>
		<link rel="stylesheet" href="/highlightjs/default.min.css">
		<script src="/highlightjs/highlight.min.js"></script>
		<script>
			$(function(){
				
				var scrollByCode = false;
				function hideMenu() {
					$("#navi").animate({left: "-250px"}, 150);
					$("#mask").animate({opacity: 0}, 150, function(){
						$("#mask").css("display", "none");
					});
				}
				$("#banner>span").mousedown(function(e){
					$("#navi").stop();
					if ($("#navi").offset().left >= 0) {
						hideMenu();
					} else {
						$("#navi").animate({left: "0px"}, 150);
						$("#mask").css("display", "block");
						$("#mask").animate({opacity:0.6}, 150);
					}
				});
				$("#mask").mousedown(function(e){
					hideMenu();
				});
				$$("navi").on("select", function(e){
					if (e.data.path) {
						scrollByCode = true;
						var distance = $("#banner").height() > 40 ? 0 : 50;
						tui.browser.scrollToElement($("#"+e.data.path)[0], distance, function(){
							scrollByCode = false;
						});
						if (distance > 0)
							hideMenu();
					}
				});
				$(window).resize(function(){
					if ($("#banner").height() > 40) {
						$("#navi").css("left", "0px");
						$("#mask").css("display", "none");
					} else if ($("#mask").css("display") === "none") {
						$("#navi").css("left", "-250px");
					}
				});
				$(window).scroll(function(e){
					if (scrollByCode)
						return;
					var findItem = null;
					var minDistance = null;
					$("h1>span[id],h2>span[id],h3>span[id],h4>span[id]").each(function(index, item){
						var distance = Math.abs(tui.browser.getRectOfPage(item).top - $(window).scrollTop());
						if (findItem == null) {
							findItem = item;
							minDistance = distance;
						} else if (distance < minDistance) {
							findItem = item;
							minDistance = distance;
						}
					});
					var currentItem = $$("navi").get("activeItem");
					if (!currentItem || currentItem.path != findItem.id) {
						console.log(findItem.id);
						$$("navi").activeBy("path", findItem.id);
					}
				});
				function repeat(str, count) {
					var result = "";
					for (var i = 0; i < count; i++)
						result += str;
					return result;
				}
				tui.ajax.getScript("doc.md").done(function(result){
					var buffer = "";
					var line;
					var reg = /.*(\r\n|\r|\n)/gm;
					function getLine() {
						if (!result)
							return null;
						var l = reg.exec(result);
						return l ? l[0] : null;
					}
					function getLevel(str) {
						var level = 0;
						for (var i = 0; i < str.length; i++) {
							var c = str[i];
							if (c === "#")
								level++;
							else
								break;
						}
						return level;
					}
					var index = [];
					var path = [];
					var lastLevel = null;
					var lineRegex = /#{1,}\s+(?:\[\]\(([^\)]*)\)\s*)?([^`]*)(?:`\((.*)\)`)?/;
					while ((line = getLine()) != null) {
						var matcher;
						if (matcher = line.match(lineRegex)) {
							var item = {};
							item.text = matcher[2];
							if (matcher[1])
								item.icon = matcher[1];
							if (matcher[3])
								item.path = matcher[3];
							var level = getLevel(line);
							if (lastLevel === null) {
								lastLevel = level;
								path.push(item);
								index.push(item);
							} else {
								if (level == lastLevel) {
									path.pop();
									if (path.length > 0)
										path[path.length - 1].children.push(item);
									else
										index.push(item);
									path.push(item);
								} else if (level > lastLevel) {
									if (!path[path.length - 1].children) {
										path[path.length - 1].children = [];
									}
									path[path.length - 1].children.push(item);
									path.push(item);
								} else {
									for (var i = 0; i <= lastLevel - level; i++)
										path.pop();
									if (path.length > 0)
										path[path.length - 1].children.push(item);
									else
										index.push(item);
									path.push(item);
								}
								lastLevel = level;
							}
							if (item.path)
								line = repeat("#", level) + " <span id='" + item.path + "'>" + item.text.trim() + "</span>" + "\n";
							else
								line = repeat("#", level) + " " + item.text.trim() + "\n";
						} 
						buffer += line;
					}
					$$("navi").set("items", index);
					$("#content").html(marked(buffer));
					tui.widget.init($("#content")[0]);
					if (tui.ieVer <= 0 || tui.ieVer > 8)
						hljs.initHighlighting();
				});
			});
		</script>
	</head>
	<body>
		<div id="banner" unselectable="on">
			<span class="fa fa-bars"></span>
			TUI.JS v2
		</div>
		<div id="mask" unselectable="on" style="display:none"></div>
		<tui:navigator id="navi" selectable={true}></tui:navigator>
		<!-- content -->
		<div id="content"></div>
		<br>
	</body>
</html>
